---
title: Integrating Segment Audiences with Knock Audiences
description: Learn how to sync Segment audience membership changes to Knock audiences using webhooks for targeted messaging campaigns.
tags: ["segment", "audiences", "webhooks", "integration"]
section: Tutorials
---

In this tutorial, we'll walk through how to integrate Segment Audiences with Knock Audiences so that when users are added to or removed from a Segment audience, those changes are automatically synced to corresponding audiences in Knock.

## Overview

Audience segmentation is crucial for delivering personalized, targeted messaging experiences. By connecting Segment's powerful audience creation capabilities with Knock's notification infrastructure, you can trigger workflows and deliver messages to precisely the right users at the right time.

This tutorial shows you how to set up a webhook-based integration that keeps your Segment and Knock audiences in sync, enabling you to leverage Segment's behavioral audience building while utilizing Knock's cross-channel messaging capabilities.

What you'll learn:

- How to create and manage audiences in Knock using the API
- How to configure Segment webhook destinations for audience changes
- How to implement both bulk sync and real-time sync approaches
- How to handle audience membership updates via webhooks
- Best practices for scaling audience integrations

<Callout
  emoji="💡"
  bgColor="blue"
  text={
    <>
      This integration requires Segment's Audiences feature and webhook
      destinations. Make sure you have access to both before proceeding.
    </>
  }
/>

## Integration architecture

The Segment + Knock audience integration follows this flow:

1. **Segment Audiences** define user segments based on behavioral criteria and traits
2. **Segment Webhook Destination** sends events when users enter or exit audiences
3. **Your webhook handler** receives audience membership changes from Segment
4. **Knock API** adds or removes users from corresponding audiences in Knock
5. **Knock workflows** can now trigger notifications based on audience membership

With this integration, you can create sophisticated messaging campaigns that respond to user behavior tracked in Segment while leveraging Knock's powerful workflow engine and multi-channel delivery capabilities.

## Prerequisites

Before starting this tutorial, make sure you have:

- A Segment account with access to Audiences and webhook destinations
- A Knock account with API access
- A server or service capable of receiving and processing webhooks
- Basic understanding of REST APIs and webhook handling

## Setting up authentication

First, you'll need to obtain your Knock API credentials to authenticate requests.

### Getting your Knock API key

1. Log into your Knock dashboard
2. Navigate to **Developers > API keys**
3. Copy your **Secret key** (starts with `sk_`)

<Callout
  emoji="⚠️"
  bgColor="orange"
  text="Keep your secret key secure! Never expose it in client-side code or commit it to version control."
/>

### Authenticating API requests

All Knock API requests require authentication using Bearer token format:

```bash
curl -X POST https://api.knock.app/v1/audiences \
  -H "Authorization: Bearer sk_your_secret_key_here" \
  -H "Content-Type: application/json"
```

## Creating a Knock audience

Before syncing users, you'll need to create a corresponding audience in Knock. The audience key should match your Segment audience identifier for consistency.

### API endpoint

```http
POST https://api.knock.app/v1/audiences
```

### Creating an audience

```javascript
const response = await fetch("https://api.knock.app/v1/audiences", {
  method: "POST",
  headers: {
    Authorization: "Bearer sk_your_secret_key_here",
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    key: "high-value-customers", // Should match your Segment audience
    name: "High Value Customers",
    description: "Users who have spent over $1000 in the last 90 days",
  }),
});

const audience = await response.json();
console.log("Created audience:", audience);
```

<Callout
  emoji="ℹ️"
  bgColor="gray"
  text="If the audience already exists in Knock, you can skip this step and proceed directly to the webhook configuration."
/>

## Configuring Segment webhook destination

Next, you'll set up a webhook destination in Segment to receive audience membership changes.

### Setting up the webhook destination

1. In your Segment workspace, go to **Destinations**
2. Click **Add Destination** and search for "Webhooks"
3. Select **Webhooks (Actions)** and connect it to your source
4. Configure the webhook URL to point to your endpoint:
   ```
   https://your-server.com/webhooks/segment-audiences
   ```

### Configuring audience events

You'll need to create webhook mappings for audience entry and exit events:

#### Audience Entered mapping:

- **Event Type**: `Audience Entered`
- **Webhook URL**: `https://your-server.com/webhooks/segment-audiences`
- **Method**: `POST`
- **Headers**:
  ```json
  {
    "Content-Type": "application/json",
    "X-Segment-Event": "audience-entered"
  }
  ```

#### Audience Exited mapping:

- **Event Type**: `Audience Exited`
- **Webhook URL**: `https://your-server.com/webhooks/segment-audiences`
- **Method**: `POST`
- **Headers**:
  ```json
  {
    "Content-Type": "application/json",
    "X-Segment-Event": "audience-exited"
  }
  ```

## Implementation approaches

There are two main approaches to syncing Segment audiences with Knock: bulk sync for initial setup and real-time sync for ongoing updates.

### Approach 1: One-time bulk sync

Use this approach to migrate existing Segment audience members to Knock.

```javascript
async function bulkSyncAudience(segmentAudienceId, knockAudienceKey, userIds) {
  const batchSize = 1000; // Knock's maximum batch size

  for (let i = 0; i < userIds.length; i += batchSize) {
    const batch = userIds.slice(i, i + batchSize);

    const response = await fetch(
      `https://api.knock.app/v1/audiences/${knockAudienceKey}/members`,
      {
        method: "POST",
        headers: {
          Authorization: "Bearer sk_your_secret_key_here",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          users: batch.map((userId) => ({ id: userId })),
        }),
      },
    );

    if (!response.ok) {
      console.error(`Failed to sync batch starting at index ${i}`);
      continue;
    }

    console.log(`Synced batch of ${batch.length} users`);
  }
}

// Example usage
const userIds = ["user123", "user456", "user789"]; // Get from Segment
await bulkSyncAudience("segment-audience-123", "high-value-customers", userIds);
```

### Approach 2: Real-time sync via webhooks

Use this approach to handle ongoing audience membership changes.

```javascript
// Express.js webhook handler example
app.post("/webhooks/segment-audiences", async (req, res) => {
  const { body, headers } = req;
  const eventType = headers["x-segment-event"];

  // Extract user and audience information from Segment payload
  const userId = body.userId || body.anonymousId;
  const audienceKey =
    body.properties?.audience_key || body.context?.personas?.audience_key;

  if (!userId || !audienceKey) {
    return res.status(400).json({ error: "Missing required fields" });
  }

  try {
    if (eventType === "audience-entered") {
      await addUserToKnockAudience(userId, audienceKey);
    } else if (eventType === "audience-exited") {
      await removeUserFromKnockAudience(userId, audienceKey);
    }

    res.status(200).json({ success: true });
  } catch (error) {
    console.error("Webhook processing failed:", error);
    res.status(500).json({ error: "Processing failed" });
  }
});

async function addUserToKnockAudience(userId, audienceKey) {
  const response = await fetch(
    `https://api.knock.app/v1/audiences/${audienceKey}/members`,
    {
      method: "POST",
      headers: {
        Authorization: "Bearer sk_your_secret_key_here",
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        users: [{ id: userId }],
      }),
    },
  );

  if (!response.ok) {
    throw new Error(`Failed to add user ${userId} to audience ${audienceKey}`);
  }
}

async function removeUserFromKnockAudience(userId, audienceKey) {
  const response = await fetch(
    `https://api.knock.app/v1/audiences/${audienceKey}/members`,
    {
      method: "DELETE",
      headers: {
        Authorization: "Bearer sk_your_secret_key_here",
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        users: [{ id: userId }],
      }),
    },
  );

  if (!response.ok) {
    throw new Error(
      `Failed to remove user ${userId} from audience ${audienceKey}`,
    );
  }
}
```

## Testing the integration

### Testing the webhook endpoint

1. Use a tool like ngrok to expose your local webhook handler:

   ```bash
   ngrok http 3000
   ```

2. Update your Segment webhook destination with the ngrok URL

3. Test audience entry/exit by manually adding/removing a user from a Segment audience

4. Verify the webhook is received and processed correctly:
   ```bash
   # Check your server logs for webhook payloads
   tail -f your-app.log
   ```

### Verifying audience sync

Check that users are properly synced in Knock:

```javascript
// List audience members to verify sync
async function verifyAudienceSync(audienceKey) {
  const response = await fetch(
    `https://api.knock.app/v1/audiences/${audienceKey}/members`,
    {
      headers: {
        Authorization: "Bearer sk_your_secret_key_here",
      },
    },
  );

  const data = await response.json();
  console.log(`Audience ${audienceKey} has ${data.entries.length} members`);
  return data.entries;
}
```

## Next steps

Now that you have Segment audiences syncing to Knock, you can:

- Create workflows that trigger when users enter specific audiences
- Use audience membership in workflow conditional logic
- Build sophisticated lifecycle marketing campaigns
- Combine multiple audience memberships for advanced targeting

Learn more about [Knock workflows](/concepts/workflows) and [Knock audiences](/concepts/audiences).
